---
title: "Clustering Pseudotime Inference on Skin Cell scRNA-seq"
author: "Matt Karikomi"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Clustering Pseudotime Inference on Skin Cell scRNA-seq}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
rm(list = ls())
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
set.seed(13)
par(mar=c(1,1,1,1))
```

This is an example of clustering, marker identification and pseudotime inference on a set of skin cells.

## Load and Preprocess Data

Load and log transform the data

```{r, results='asis'}
library(RSoptSC)
data("GSE67602_Joost")
logdata <- log10(GSE67602_Joost$data + 1)
```

### Remove Spike-in RNA
```{r}
# clean the gene names
gene_names <- GSE67602_Joost$gene_names
spikein <- grep('ERCC', gene_names)
gene_names <- gene_names[-spikein]

# clean the data
logdata <- logdata[-spikein,]
```

Apply number of features and exclusion threshold

```{r, results='asis'}
gene_expression_threshold <- 0.03
n_features <- 3000
filtered_data <- SelectData(logdata, gene_expression_threshold, n_features)
```

## Compute the Similarity Matrix

Run L2R2 on the processed data, outputting the number of iterations and value of the objective.

```{r, results='asis'}
S <- SimilarityM(lambda = 0.05, data = filtered_data$M_variable)
```

Compute distances on the similarity matrix.  If the truncated graph has multiple components, join them to improve inter-cluster distance estimation.

```{r, results='asis'}
# perplexity = perplexity,
#                                   pca_center = TRUE,
#                                   pca_scale = TRUE,
#                                   dims = 2
low_dim_mapping <- RepresentationMap(similarity_matrix = S$W,
                            join_components = FALSE,
                            perplexity = 50,
                            theta = 0.5,
                            normalize = FALSE,
                            pca = TRUE,
                            pca_center = TRUE,
                            pca_scale = TRUE,
                            dims = 2)
```

## Cluster the Cells

Infer cluster number using spectra of the ensemble Laplacian.

```{r, results='asis'}
clusters_evalues <- CountClusters(data = S$W)
n_clusters <- clusters_evalues$n
```

In this analysis, we obtain bounds on the number of clusters, where the lower bound is equal to the number of zero eigenvalues and the upper bound is the index of the eigenvalue preceding the largest eigengap.  We take this value as the cluster number here.

```{r, results='asis'}
par(mar=c(1,1,1,1))
plot(c(1:20), 
     clusters_evalues$eigs$val[1:20],
     xlab = NA,
     ylab = 'eigenvalues',
     main = 'Eigenvalues of the Graph Laplacian')
```


Factor the similarity matrix such that W = HxH', using the computed cluster number for the rank of H.

```{r, results='asis', warning=FALSE}
output_NMF <- NMF::nmf(x = S$W,
              rank = n_clusters,
              method = 'lee',
              seed = 'nndsvd',
              .options = 'nP');
H <- NMF::basis(output_NMF)
```

Assign cluster labels to the cells.

```{r, results='asis'}
labels <- apply(H, 1, function(x){
  which(x == max(x))})
```


### Visualize the Clusters

Cells are labeled by cluster membership and plotted on low-dimensional embedding (t-SNE) of the similarity matrix.

```{r, results='asis', out.width = '100%', out.height = '100%', fig.width = 7, fig.heigt = 7}
# define a scheme for the coloring.  This is a required parameter for plotting discrete (factor) data
colorscale <- ColorHue(n = length(unique(labels)))
colorscale <- colorscale$hex.1.n.

# plot clusters
par(mar=c(1,1,1,1))
FeatureScatterPlot(flat_embedding = low_dim_mapping$flat_embedding,
                         feature = as.factor(labels),
                         title = "NMF Cluster Labeling",
                         subtitle = "t-SNE Embedding",
                         featurename = "Cluster ID",
                         colorscale = colorscale)
```

As described in Joost et al (2016), Subpopulations including Basal, IFE-DI, IFE-DII, IFE-KI, IFE-KII were identified by standard techniques.

```{r, results='asis', out.width = '100%', out.height = '100%', fig.width = 7, fig.heigt = 7}
true_labels <- RSoptSC::GSE67602_Joost$annotation
# plot clusters
par(mar=c(1,1,1,1))
FeatureScatterPlot(flat_embedding = low_dim_mapping$flat_embedding,
                         feature = as.factor(true_labels),
                         title = "True Labeling",
                         subtitle = "t-SNE Embedding",
                         featurename = "Annotated Cell Types")
```

## Find cluster marker genes.

Previously, we clustered the cells using L2R2/Sym-NMF, now we analyze the markers of the clusters.  We look at the normalized expression values of all genes using pre-selection parameters similar to the pre-clustering selection parameters.  The top six markers selected as described in Wang et. al.  As expected, markers Krt14, Krt10, and Lor are inferred for clusters overlapping with IHC-based Basal, Differentiated (IFE-DI, IFE-DII), and Keratinized (IFE-KI, IFE-KII) cell annotations.   

```{r, fig.width=7, fig.height=7}

markers <- GetMarkerTable(counts_data = logdata,
                          cluster_labels = labels,
                          H = H,
                          gene_expression_threshold = 6,
                          n_features = 20000)

PlotTopN(data = logdata,
         gene_names = gene_names,
         cluster_labels = labels,
         markers = markers,
         n_features = 6)
```

## Pseudotime Inference

Compute cluster-cluster graph and find the root cluster.

```{r, results='asis'}
cluster_ptime <- FindRootCluster(cluster_labels = labels,
                                 flat_embedding = low_dim_mapping$flat_embedding,
                                 dist_graph = low_dim_mapping$dist_graph,
                                 dist_flat = low_dim_mapping$dist_flat,
                                 reverse = TRUE)
```

Compute the cell-cell graph and find the root cell.

```{r, results='asis'}
root_cell <- FindRootCell(use_flat_dist = FALSE,
                          cluster_order_by = "distance",
                          cell_order_by = "distance",
                          graph_cluster_mst = cluster_ptime$cluster_mst,
                          dist_graph  = low_dim_mapping$dist_graph,
                          dist_flat = low_dim_mapping$dist_flat,
                          cluster_labels = labels,
                          root_cluster = cluster_ptime$root_cluster)
```

## Pseudotime Visualization

Compute the directional minimum spanning tree on the cluster-cluster graph for visualization.

```{r, results='asis', out.width = '100%', out.height = '100%', fig.width = 7, fig.heigt = 7}
par(mar=c(1,1,1,1))
cluster_predecessors <- GetPredecessors(cluster_ptime$cluster_mst, cluster_ptime$root_cluster)
cluster_dtree <- GetDominatorTree(cluster_predecessors, cluster_ptime$graph_cluster)
PlotLineage(cluster_dtree)
```


Compute the path-length vector from root, and plot the cells in the previously computed low-dimensional embedding.

```{r, results='asis', out.width = '100%', out.height = '100%', fig.width = 7, fig.heigt = 7}
pseudotime <- low_dim_mapping$dist_graph[root_cell,]

# plot pseudotime
par(mar=c(1,1,1,1))
FeatureScatterPlot(flat_embedding = low_dim_mapping$flat_embedding,
                         feature = pseudotime,
                         title = "Pseudotime Labeling",
                         subtitle = "t-SNE Embedding",
                         featurename = "Relative L2R2 Distance from Root")
```

## Plot Gene Expression on the Flat Embedding

Plot Expression of Krt14, Krt10, and Lor in t-SNE Space:

```{r, results='asis', out.width = '100%', out.height = '100%', fig.width = 7, fig.heigt = 7}
gene_index <- which(gene_names == 'Krt14')
data_gene <- logdata[gene_index,]

# plot features
par(mar=c(1,1,1,1))
FeatureScatterPlot(flat_embedding = low_dim_mapping$flat_embedding,
                    feature = data_gene,
                    title = "Krt14 Expression",
                    subtitle = "t-SNE Embedding",
                    featurename = "Log Krt14 Expression")
```

```{r, results='asis', out.width = '100%', out.height = '100%', fig.width = 7, fig.heigt = 7}
gene_index <- which(gene_names == 'Krt10')
data_gene <- logdata[gene_index,]

# plot features
par(mar=c(1,1,1,1))
FeatureScatterPlot(flat_embedding = low_dim_mapping$flat_embedding,
                    feature = data_gene,
                    title = "Krt10 Expression",
                    subtitle = "t-SNE Embedding",
                    featurename = "Log Krt10 Expression")
```

```{r, results='asis', out.width = '100%', out.height = '100%', fig.width = 7, fig.heigt = 7}
gene_index <- which(gene_names == 'Lor')
data_gene <- logdata[gene_index,]

# plot features
par(mar=c(1,1,1,1))
FeatureScatterPlot(flat_embedding = low_dim_mapping$flat_embedding,
                    feature = data_gene,
                    title = "Lor Expression",
                    subtitle = "t-SNE Embedding",
                    featurename = "Log Lor Expression")
```

## Plot Gene Expression Levels in Cells Grouped by Cluster

Violin Plot of Krt14 expression.  Note strong expression of the basal compartment (clusters 1 and 6):

```{r, results='asis', out.width = '100%', out.height = '100%', fig.width = 7, fig.heigt = 7}
  par(mar=c(1,1,1,1))
  ViolinPlotExpression(data = logdata,
                       gene_names = gene_names,
                       labels = labels,
                       gene_name = "Krt14")
```
Violin Plot of Krt10 expression.  Note uniformly high expression in the IFE-DI/DII compartments (clusters 2, 4, 5, 7).  Note that the mixed expression of Krt10 in cluster 3, which may indicate a population of cells whose global expression profile marks an intermediate state prior to the fully differentiated keratinized layer:

```{r, results='asis', out.width = '100%', out.height = '100%', fig.width = 7, fig.heigt = 7}
  par(mar=c(1,1,1,1))
  ViolinPlotExpression(data = logdata,
                       gene_names = gene_names,
                       labels = labels,
                       gene_name = "Krt10")
```
Violin Plot of Lor expression.  Note strong expression in clusters 3 and 5, which encompass IFE-KI/KII compartments:

```{r, results='asis', out.width = '100%', out.height = '100%', fig.width = 7, fig.heigt = 7}
  par(mar=c(1,1,1,1))
  ViolinPlotExpression(data = logdata,
                       gene_names = gene_names,
                       labels = labels,
                       gene_name = "Lor")
```

## Analyze Signaling Mediated by a Ligand-Receptor Family

We present a family of ligan-receptor pairs along with their up/down-regulated targets.  We compute the probability of intercellular interaction based on this pathway.

```{r, results='hide', out.width = '100%', out.height = '100%', fig.width = 7, fig.heigt = 7, message=FALSE}
  ligands <- list(Tgfb1 = list(Tgfbr1 = list(up = list('Zeb2','Smad2','Wnt4','Wnt11','Bmp7','Sox9','Notch1')),
                               Tgfbr2 = list(up = list('Zeb2','Smad2','Wnt4','Wnt11','Bmp7','Sox9','Notch1'))),
                  Tgfb2 = list(Tgfbr1 = list(up = list('Zeb2','Smad2','Wnt4','Wnt11','Bmp7','Sox9','Notch1')),
                               Tgfbr2 = list(up = list('Zeb2','Smad2','Wnt4','Wnt11','Bmp7','Sox9','Notch1'))))
  Pmats <- GetSignalingPartners(logdata,
                                  gene_names,
                                  ligands)
```

### Circos Plot of Intercellular Network
Now plot the previous result as a circos plot on the top five ligand-producing and top five receptor-bearing cells from every cluster.  The upper hemisphere of the plot shows receptor-bearing cells.  The chords of the plot are colored by the ligand-producing cells in the lower hemisphere.

```{r, out.height='100%', out.width='100%'}
  par(mar=c(1,1,1,1))

SigPlot(P = Pmats$P_agg,
        cluster_labels = labels,
        lig_cells_per_cluster = 5,
        rec_cells_per_cluster = 5,
        rgb_gap = 0.60)
```

### Circos Plot of Intercluster Network
Directional plot of cluster-to-cluster signaling.  The root of the directional chord is raised.

```{r, out.width = '100%', out.height = '100%', fig.width = 7, fig.heigt = 7}
  cluster_P <- ClusterSig(Pmats$P_agg,
                          cluster_labels = labels)
  SigPlot(P = cluster_P,
          cluster_labels = c(1:n_clusters),
          rgb_gap = 0.60)
```

### Heatmap of Signaling Marker Expression

Visualize the expression of ligand/receptor and up/down target expression across clusters

```{r, results='asis', warning=FALSE, message= FALSE, out.width = '100%', out.height = '100%', fig.width = 7, fig.heigt = 7}
  par(mar=c(1,1,1,1))

  gene_list = c('Tgfb1', 'Tgfb2', 
                'Tgfbr1', 'Tgfbr2',
                'Zeb2','Smad2','Wnt4','Wnt11','Bmp7','Sox9','Notch1')

  PlotClusterExpression(data = logdata,
                        gene_names = gene_names,
                        cluster_labels = labels, 
                        markers = gene_list)
```
