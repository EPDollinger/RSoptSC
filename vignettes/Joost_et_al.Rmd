---
title: "Clustering Pseudotime Inference on Skin Cell scRNA-seq"
author: "Matt Karikomi"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Clustering Pseudotime Inference on Skin Cell scRNA-seq}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This is an example of clustering, marker identification and pseudotime inference on a set of skin cells.

## Load and Preprocess Data

Load and log transform the data

```{r, results='asis'}
library(RSoptSC)
data("GSE67602_Joost")
logdata <- log10(GSE67602_Joost$data + 1)
```

Apply number of features and exclusion threshold

```{r, results='asis'}
gene_expression_threshold <- 0.03
n_features <- 3000
filtered_data <- SelectData(logdata, gene_expression_threshold, n_features)
```

## Compute the Similarity Matrix

Run L2R2 on the processed data, outputting the number of iterations and value of the objective.

```{r, results='asis'}
sim <- SimilarityM(lambda = 0.05, data = filtered_data$M_variable)
```

## Cluster the Cells

Infer cluster number using spectra of the ensemble Laplacian.

```{r, results='asis'}
n_clusters <- CountClusters(data = sim$W)
```

Factor the similarity matrix such that W = HxH', using the computed cluster number for the rank of H.

```{r, results='asis'}
H <- NNLM::nnmf(sim$W, n_clusters, rel.tol = 1e-6);
```

Assign cluster labels to the cells.

```{r, results='asis'}
labels <- apply(H$W, 1, function(x){
  which(x == max(x))})
```

## Find cluster marker genes.

Previously, we clustered the cells using L2R2/Sym-NMF, now we analyze the markers of the clusters.  We look at the normalized expression values of all genes using pre-selection parameters similar to the pre-clustering selection parameters. 

```{r, results='asis'}
markers <- GetMarkerTable(counts_data = logdata,
                          cluster_labels = labels,
                          H = H$W,
                          gene_expression_threshold = gene_expression_threshold,
                          n_features = n_features)
heatplot <- MarkerHeatmap(logdata,labels,markers,n_markers = 5)

```

## Pseudotime Inference

Compute distances on the similarity matrix.  If the truncated graph has multiple components, join them to improve inter-cluster distance estimation.

```{r, results='asis'}
mapped <- RepresentationMap(similarity_matrix = sim$W,
                            join_components = TRUE)
```

Compute cluster-cluster graph and find the root cluster.

```{r, results='asis'}
cluster_ptime <- FindRootCluster(cluster_labels = labels,
                                 flat_embedding = mapped$flat_embedding,
                                 dist_graph = mapped$dist_graph,
                                 dist_flat = mapped$dist_flat,
                                 reverse = FALSE)
```

Compute the cell-cell graph and find the root cell.

```{r, results='asis'}
root_cell <- FindRootCell(cluster_order_by = "distance",
                           cell_order_by = "distance",
                           graph_cluster_mst = cluster_ptime$cluster_mst,
                           dist_graph  = mapped$dist_graph,
                           dist_flat = mapped$dist_flat,
                           cluster_labels = labels,
                           root_cluster = cluster_ptime$root_cluster)
```

## Pseudotime Visualization

Compute the directional minimum spanning tree on the cluster-cluster graph for visualization.

```{r, results='asis', out.width = '100%', out.height = '100%', fig.width = 7, fig.heigt = 7}
cluster_predecessors <- GetPredecessors(cluster_ptime$cluster_mst, cluster_ptime$root_cluster)
cluster_dtree <- GetDominatorTree(cluster_predecessors, cluster_ptime$graph_cluster)
PlotLineage(cluster_dtree)
```

Compute the path-length vector from root, and plot the cells in the previously computed low-dimensional embedding.

```{r, results='asis', out.width = '100%', out.height = '100%', fig.width = 7, fig.heigt = 7}
pseudotime <- mapped$dist_graph[root_cell,]

# plot pseudotime
p <- PseudotimeScatterPlot(flat_embedding = mapped$flat_embedding,
                            pseudotime = pseudotime)
plot(p + ggplot2::geom_point())

```
